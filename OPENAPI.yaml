openapi: 3.1.0
info:
  title: Ticketr API
  version: 1.0.0
  description: >-
    Core ticket endpoints for the Ticketr helpdesk. All requests must include
    tenant and brand headers to guarantee scoped access.
servers:
  - url: http://localhost
paths:
  /api/tickets:
    get:
      summary: List tickets
      tags: [Tickets]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
      responses:
        '200':
          description: Paginated ticket collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketCollection'
    post:
      summary: Create a ticket
      tags: [Tickets]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketRequest'
            examples:
              create-ticket:
                value:
                  brand_id: 1
                  contact_id: 42
                  company_id: 11
                  subject: Checkout fails for VIP customer
                  description: Customer cannot complete payment.
                  priority: urgent
                  channel: web
                  category_ids: [5]
                  tag_ids: [2, 7]
      responses:
        '201':
          description: Ticket created
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketResponse'
  /api/tickets/bulk-actions:
    post:
      summary: Apply bulk ticket actions
      tags: [Tickets]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketBulkActionRequest'
            examples:
              assign-and-status:
                value:
                  ticket_ids: [1, 2]
                  actions:
                    - type: assign
                      assignee_id: 7
                    - type: status
                      status: pending
      responses:
        '202':
          description: Bulk action accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketBulkActionResponse'
  /api/tickets/{ticket}:
    get:
      summary: Retrieve a ticket
      tags: [Tickets]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
        - $ref: '#/components/parameters/TicketId'
      responses:
        '200':
          description: Ticket details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketResponse'
    put:
      summary: Update a ticket
      tags: [Tickets]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
        - $ref: '#/components/parameters/TicketId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketRequest'
      responses:
        '200':
          description: Ticket updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketResponse'
    delete:
      summary: Archive/delete a ticket
      tags: [Tickets]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
        - $ref: '#/components/parameters/TicketId'
      responses:
        '202':
          description: Ticket archived (soft deleted)
  /api/tickets/{ticket}/messages:
    get:
      summary: List ticket messages
      tags: [Ticket Messages]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
        - $ref: '#/components/parameters/TicketId'
      responses:
        '200':
          description: Paginated ticket message collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketMessageCollection'
    post:
      summary: Append a ticket message
      tags: [Ticket Messages]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
        - $ref: '#/components/parameters/TicketId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketMessageRequest'
            examples:
              append-message:
                value:
                  body: "Agent reply captured from email"
                  visibility: internal
                  channel: email
                  author_type: user
                  author_id: 17
                  external_id: "gmail-abc123"
                  participants:
                    - participant_type: user
                      participant_id: 17
                      role: agent
                      visibility: internal
                  attachments:
                    - disk: local
                      path: attachments/reply.pdf
                      filename: reply.pdf
                      mime_type: application/pdf
                      size: 2048
      responses:
        '201':
          description: Ticket message created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketMessageResponse'
  /api/tickets/{ticket}/ingest:
    post:
      summary: Ingest a channel message
      tags: [Ticket Messages]
      security:
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/TenantHeader'
        - $ref: '#/components/parameters/BrandHeader'
        - $ref: '#/components/parameters/TicketId'
        - $ref: '#/components/parameters/ChannelTokenHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketMessageRequest'
            examples:
              ingest-message:
                value:
                  body: "Inbound email reply"
                  channel: email
                  visibility: internal
                  author_type: user
                  author_id: 42
                  external_id: "imap-123"
                  attachments:
                    - disk: local
                      path: attachments/inbound.eml
                      filename: inbound.eml
                      mime_type: message/rfc822
                      size: 8192
      responses:
        '201':
          description: Ticket message ingested
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketMessageResponse'
        '401':
          description: Invalid or missing channel token
  /api/health:
    get:
      summary: Service health snapshot
      tags: [Observability]
      parameters:
        - $ref: '#/components/parameters/MonitoringTokenHeader'
      responses:
        '200':
          description: Connectivity status for critical dependencies
          content:
            application/json:
              examples:
                healthy:
                  value:
                    database: true
                    redis: true
                    queue: true
                    scout: false
                    timestamp: '2024-01-01T12:00:00Z'
        '401':
          description: Missing or invalid monitoring token
        '403':
          description: Request IP not permitted
  /api/security/two-factor:
    post:
      summary: Enroll the current user in two-factor authentication
      tags: [Security]
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Enrollment secret and recovery codes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorEnrollmentResponse'
    delete:
      summary: Disable two-factor authentication
      tags: [Security]
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Two-factor authentication disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
  /api/security/two-factor/confirm:
    post:
      summary: Confirm two-factor authentication
      tags: [Security]
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TwoFactorConfirmRequest'
      responses:
        '200':
          description: Two-factor authentication confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '422':
          description: Invalid verification code
  /api/security/ip-restrictions:
    patch:
      summary: Update per-user IP allow/block lists
      tags: [Security]
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IpRestrictionRequest'
      responses:
        '200':
          description: IP restrictions updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: laravel_session
  parameters:
    TenantHeader:
      name: X-Tenant
      in: header
      required: true
      schema:
        type: integer
    ChannelTokenHeader:
      name: X-Channel-Token
      in: header
      required: true
      schema:
        type: string
      description: Shared secret for channel ingestion adapters.
    MonitoringTokenHeader:
      name: X-Monitoring-Token
      in: header
      required: true
      schema:
        type: string
      description: Hashable token whose SHA-256 value is stored in monitoring_tokens.
      description: Active tenant identifier.
    BrandHeader:
      name: X-Brand
      in: header
      required: true
      schema:
        type: integer
      description: Active brand identifier.
    TicketId:
      name: ticket
      in: path
      required: true
      schema:
        type: integer
  schemas:
    TicketCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Ticket'
        links:
          type: object
        meta:
          type: object
    TicketResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Ticket'
    TicketMessageCollection:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TicketMessage'
        links:
          type: object
        meta:
          type: object
    TicketMessageResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/TicketMessage'
    TicketBulkActionRequest:
      type: object
      required: [ticket_ids, actions]
      properties:
        ticket_ids:
          type: array
          items:
            type: integer
        actions:
          type: array
          items:
            type: object
            required: [type]
            properties:
              type:
                type: string
                enum: [assign, status, sla]
              assignee_id:
                type: integer
              status:
                type: string
              resolution_due_at:
                type: string
                format: date-time
              first_response_due_at:
                type: string
                format: date-time
    TicketBulkActionResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            processed:
              type: integer
            skipped:
              type: integer
            errors:
              type: array
              items:
                type: object
                properties:
                  ticket_id:
                    type: integer
                  reason:
                    type: string
                  messages:
                    type: array
                    items:
                      type: string
    MessageResponse:
      type: object
      properties:
        message:
          type: string
      required: [message]
    TwoFactorEnrollmentResponse:
      type: object
      properties:
        secret:
          type: string
          description: Base32 encoded TOTP secret.
        otpauth_uri:
          type: string
          description: otpauth URI compatible with authenticator apps.
        recovery_codes:
          type: array
          items:
            type: string
      required: [secret, otpauth_uri, recovery_codes]
    TwoFactorConfirmRequest:
      type: object
      required: [code]
      properties:
        code:
          type: string
          pattern: '^\\d{6}$'
    IpRestrictionRequest:
      type: object
      properties:
        ip_allowlist:
          type: array
          items:
            type: string
            format: ipv4
        ip_blocklist:
          type: array
          items:
            type: string
            format: ipv4
    TicketMessage:
      type: object
      properties:
        id:
          type: integer
        ticket_id:
          type: integer
        visibility:
          type: string
        channel:
          type: string
        body:
          type: string
        metadata:
          type: object
          additionalProperties: true
        attachments_count:
          type: integer
        posted_at:
          type: string
          format: date-time
        author:
          type: object
          properties:
            type:
              type: string
            id:
              type: integer
        attachments:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              filename:
                type: string
              mime_type:
                type: string
              size:
                type: integer
              metadata:
                type: object
                additionalProperties: true
    TicketMessageRequest:
      type: object
      required: [body]
      properties:
        body:
          type: string
        visibility:
          type: string
          enum: [public, internal]
        channel:
          type: string
        author_type:
          type: string
          enum: [user, contact, system]
        author_id:
          type: integer
        external_id:
          type: string
        metadata:
          type: object
          additionalProperties: true
        posted_at:
          type: string
          format: date-time
        participants:
          type: array
          items:
            type: object
            properties:
              participant_type:
                type: string
                enum: [user, contact, system]
              participant_id:
                type: integer
              role:
                type: string
                enum: [requester, cc, agent, watcher]
              visibility:
                type: string
                enum: [internal, external]
              last_seen_at:
                type: string
                format: date-time
              last_typing_at:
                type: string
                format: date-time
              is_muted:
                type: boolean
              metadata:
                type: object
                additionalProperties: true
        attachments:
          type: array
          items:
            type: object
            properties:
              disk:
                type: string
              path:
                type: string
              filename:
                type: string
              mime_type:
                type: string
              size:
                type: integer
              metadata:
                type: object
                additionalProperties: true
    TicketRequest:
      type: object
      properties:
        brand_id:
          type: integer
        contact_id:
          type: integer
        company_id:
          type: integer
        subject:
          type: string
        description:
          type: string
        priority:
          type: string
          description: Priority slug available to the active tenant (e.g. normal, high).
        channel:
          type: string
          enum: [email, web, chat, phone]
        status:
          type: string
          description: Status slug available to the active tenant (e.g. open, pending).
        reference:
          type: string
        metadata:
          type: object
          additionalProperties: true
        category_ids:
          type: array
          items:
            type: integer
        tag_ids:
          type: array
          items:
            type: integer
      required: [subject, priority]
    Ticket:
      type: object
      properties:
        id:
          type: integer
        tenant_id:
          type: integer
        brand_id:
          type: integer
        contact_id:
          type: integer
        company_id:
          type: integer
        created_by:
          type: integer
        assigned_to:
          type: integer
        subject:
          type: string
        description:
          type: string
        status:
          type: string
        priority:
          type: string
        channel:
          type: string
        reference:
          type: string
        metadata:
          type: object
          additionalProperties: true
        status_definition:
          $ref: '#/components/schemas/TicketStatus'
        priority_definition:
          $ref: '#/components/schemas/TicketPriority'
        sla:
          $ref: '#/components/schemas/TicketSlaSnapshot'
        status_changed_at:
          type: string
          format: date-time
        first_response_due_at:
          type: string
          format: date-time
        resolution_due_at:
          type: string
          format: date-time
        first_responded_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time
        closed_at:
          type: string
          format: date-time
        archived_at:
          type: string
          format: date-time
        last_customer_reply_at:
          type: string
          format: date-time
        last_agent_reply_at:
          type: string
          format: date-time
        last_activity_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
        categories:
          type: array
          items:
            $ref: '#/components/schemas/TicketCategory'
        tags:
          type: array
          items:
            $ref: '#/components/schemas/TicketTag'
    TicketStatus:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        is_default:
          type: boolean
        first_response_minutes:
          type: integer
        resolution_minutes:
          type: integer
    TicketPriority:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        color:
          type: string
        is_default:
          type: boolean
        first_response_minutes:
          type: integer
        resolution_minutes:
          type: integer
    TicketSlaSnapshot:
      type: object
      properties:
        first_response:
          $ref: '#/components/schemas/TicketSlaMetric'
        resolution:
          $ref: '#/components/schemas/TicketSlaMetric'
    TicketSlaMetric:
      type: object
      properties:
        state:
          type: string
          enum: [pending, breached, met]
        due_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        breached_at:
          type: string
          format: date-time
    TicketCategory:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        color:
          type: string
        is_default:
          type: boolean
    TicketTag:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        color:
          type: string
